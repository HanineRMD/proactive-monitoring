<!DOCTYPE html>
<html>
<head>
    <title>Tableau de bord Surveillance en Temps R√©el</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ok { background: #2ecc71; }
        .status-warning { background: #f39c12; }
        .status-critical { background: #e74c3c; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .metric-value {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .incident-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .incident-item {
            padding: 10px;
            border-left: 4px solid #e74c3c;
            margin: 5px 0;
            background: #fff5f5;
        }
        
        .action-item {
            padding: 10px;
            border-left: 4px solid #3498db;
            margin: 5px 0;
            background: #f0f8ff;
        }
        
        .timestamp {
            font-size: 0.8em;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Syst√®me de Surveillance Proactive</h1>
        <p>Monitoring en temps r√©el et auto-r√©paration</p>
        <div style="margin-top: 10px;">
            <span id="last-update"></span>
            <span id="system-status" style="float: right;"></span>
        </div>
    </div>
    
    <div class="container">
        <!-- M√©triques en temps r√©el -->
        <div class="grid">
            <div class="card">
                <h3>üìà M√©triques en Temps R√©el</h3>
                <div id="real-time-metrics"></div>
            </div>
            
            <div class="card">
                <h3>‚ö†Ô∏è Derni√®res Anomalies</h3>
                <div id="recent-anomalies" class="incident-list"></div>
            </div>
            
            <div class="card">
                <h3>üîß Actions R√©centes</h3>
                <div id="recent-actions" class="incident-list"></div>
            </div>
        </div>
        
        <!-- Graphiques -->
        <div class="grid">
            <div class="card">
                <h3>üìä Utilisation CPU</h3>
                <div id="cpu-chart" style="height: 300px;"></div>
            </div>
            
            <div class="card">
                <h3>üíæ Utilisation M√©moire</h3>
                <div id="memory-chart" style="height: 300px;"></div>
            </div>
            
            <div class="card">
                <h3>üíø Utilisation Disque</h3>
                <div id="disk-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Fonction de formatage
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        // Fonction pour mettre √† jour les m√©triques
        async function updateMetrics() {
            try {
                const response = await fetch('/api/metrics/6');
                const data = await response.json();
                
                // Mettre √† jour le timestamp
                document.getElementById('last-update').innerHTML = 
                    `Derni√®re mise √† jour: ${formatDate(data.timestamp)}`;
                
                // Afficher les derni√®res m√©triques
                if (data.metrics && data.metrics.length > 0) {
                    const latest = data.metrics[data.metrics.length - 1];
                    const metricsHtml = `
                        <div class="metric">
                            <span>CPU:</span>
                            <span class="metric-value" style="color: ${latest.cpu_percent > 80 ? '#e74c3c' : '#27ae60'}">
                                ${latest.cpu_percent.toFixed(1)}%
                            </span>
                        </div>
                        <div class="metric">
                            <span>M√©moire:</span>
                            <span class="metric-value" style="color: ${latest.memory_percent > 80 ? '#e74c3c' : '#27ae60'}">
                                ${latest.memory_percent.toFixed(1)}%
                            </span>
                        </div>
                        <div class="metric">
                            <span>Disque:</span>
                            <span class="metric-value" style="color: ${latest.disk_percent > 80 ? '#e74c3c' : '#27ae60'}">
                                ${latest.disk_percent.toFixed(1)}%
                            </span>
                        </div>
                    `;
                    document.getElementById('real-time-metrics').innerHTML = metricsHtml;
                }
                
                // Afficher les anomalies
                if (data.anomalies && data.anomalies.length > 0) {
                    let anomaliesHtml = '';
                    data.anomalies.forEach(anomaly => {
                        const details = JSON.parse(anomaly.details);
                        anomaliesHtml += `
                            <div class="incident-item">
                                <strong>${anomaly.anomaly_type}</strong> - ${anomaly.level}
                                ${details.service ? ` (${details.service})` : ''}
                                <div class="timestamp">${formatDate(anomaly.timestamp)}</div>
                            </div>
                        `;
                    });
                    document.getElementById('recent-anomalies').innerHTML = anomaliesHtml;
                }
                
                // Afficher les actions
                if (data.actions && data.actions.length > 0) {
                    let actionsHtml = '';
                    data.actions.forEach(action => {
                        const details = JSON.parse(action.details);
                        const successIcon = action.success ? '‚úÖ' : '‚ùå';
                        actionsHtml += `
                            <div class="action-item">
                                ${successIcon} <strong>${action.action_type}</strong>
                                ${details.service ? ` - ${details.service}` : ''}
                                <div class="timestamp">${formatDate(action.timestamp)}</div>
                            </div>
                        `;
                    });
                    document.getElementById('recent-actions').innerHTML = actionsHtml;
                }
                
                // Mettre √† jour les graphiques
                updateCharts(data.metrics);
                
            } catch (error) {
                console.error('Erreur mise √† jour:', error);
            }
        }
        
        // Fonction pour mettre √† jour les graphiques
        function updateCharts(metrics) {
            if (!metrics || metrics.length === 0) return;
            
            const timestamps = metrics.map(m => new Date(m.timestamp));
            const cpuData = metrics.map(m => m.cpu_percent);
            const memoryData = metrics.map(m => m.memory_percent);
            const diskData = metrics.map(m => m.disk_percent);
            
            // Graphique CPU
            const cpuTrace = {
                x: timestamps,
                y: cpuData,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'CPU',
                line: {color: '#3498db'}
            };
            
            Plotly.newPlot('cpu-chart', [cpuTrace], {
                title: 'Utilisation CPU (%)',
                xaxis: {title: 'Temps'},
                yaxis: {title: 'Pourcentage'}
            });
            
            // Graphique M√©moire
            const memoryTrace = {
                x: timestamps,
                y: memoryData,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'M√©moire',
                line: {color: '#2ecc71'}
            };
            
            Plotly.newPlot('memory-chart', [memoryTrace], {
                title: 'Utilisation M√©moire (%)',
                xaxis: {title: 'Temps'},
                yaxis: {title: 'Pourcentage'}
            });
            
            // Graphique Disque
            const diskTrace = {
                x: timestamps,
                y: diskData,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Disque',
                line: {color: '#e74c3c'}
            };
            
            Plotly.newPlot('disk-chart', [diskTrace], {
                title: 'Utilisation Disque (%)',
                xaxis: {title: 'Temps'},
                yaxis: {title: 'Pourcentage'}
            });
        }
        
        // Mettre √† jour toutes les 10 secondes
        setInterval(updateMetrics, 10000);
        
        // Premier chargement
        updateMetrics();
    </script>
</body>
</html>